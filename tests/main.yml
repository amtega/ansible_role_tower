---
# Tasks for testing role

- name: Configure vagrant sandbox environment
  hosts: localhost
  roles:
    - role: amtega.vagrant_presets
      vars:
        vagrant_presets_boxes_json_query: >-
          [? starts_with(name, `centos-7`) ]
  tags:
    - sandbox

- name: Run idempotence test
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vars:
        vagrant_sandbox_state: started
        vagrant_provisioner_vm_memory: 4096
  tags:
    - sandbox

- name: Prepare testing environment
  hosts: vagrant_sandbox_vms
  tasks:
    - name: Configure base variables
      set_fact:
        tower_nginx_disable_https: yes
        tower_settings:
          - name: TOWER_URL_BASE
            value: "https://www.acme.com"

        tower_organizations:
          - name: test_organization
            description: Test organization

        tower_organizations_defaults:
          state: present

        tower_teams:
          - name: test_team
            description: Test team

        tower_teams_defaults:
          organization: test_organization
          state: present

        tower_users:
          - username: test1
            password: test1
            email: test1@acme.com
          - username: test2
            password: test2
            email: test2@acme.com
        tower_users_defaults:
          state: present

        tower_credentials:
          - name: test_credential
            description: Test credential
            kind: ssh
            username: test
            passwword: test
            state: present
        tower_credentials_defaults:
          organization: test_organization
          user: admin

        tower_projects:
          - name: test_project
            description: Test inventory
            scm_url: https://github.com/ansible/ansible-examples.git
            scm_branch: master
        tower_projects_defaults:
          organization: test_organization
          scm_type: git
          scm_branch: master
          scm_update_on_launch: yes
          state: present

    - name: Configure additional variables
      set_fact:
        tower_inventories:
          - name: "{{ tower_projects.0.name }}"
            description: "{{ tower_projects.0.description }}"
            sources:
              - name: "{{ tower_projects.0.name }}"
                description: "{{ tower_projects.0.description }}"
                source_project: "{{ tower_projects.0.name }}"
        tower_inventories_defaults:
          organization: test_organization
          state: present
        tower_inventories_sources_defaults:
          source: scm
          state: present
          update_on_project_update: yes

        tower_templates_defaults:
          ask_credential: no
          ask_diff_mode: no
          ask_extra_vars: no
          ask_inventory: no
          ask_job_type: no
          ask_limit: no
          ask_skip_tags: no
          ask_tags: no
          ask_verbosity: no
          become_enabled: yes
          concurrent_jobs_enabled: yes
          credential: test_credential
          inventory: test_project
          job_type: run
          state: present
          survey_enabled: no
          credentials:
            - name: test_credential
              type: machine
              state: present

        tower_templates:
          - name: test_template
            description: Test template
            project: test_project
            playbook: tomcat-standalone/site.yml
            survey_spec:
              name: Survery
              description: Test survery
              spec:
                - type: text
                  question_name: Test
                  question_description: Test
                  variable: test
                  default: test
                  required: yes
            schedules:
              - name: test_schedule
                rrule: >-
                  DTSTART;TZID=Europe/Madrid:20190611T000000
                  RRULE:FREQ=MINUTELY;INTERVAL=30
                enabled: yes
                state: present

        tower_roles_defaults:
          state: present

        tower_roles:
          - job_template: test_template
            role: execute
            user: admin

- name: Test tower role with AWX
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.tower
      vars:
        tower_version: 7.0.0.599
        tower_type: awx
  tasks:
      - name: Verify awx console
        uri:
          url: http://localhost:80
          return_content: yes
          validate_certs: false
  tags:
    - idempotence

- name: Test tower role object removal with AWX
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.tower
      vars:
        tower_version: 7.0.0.599
        tower_type: awx

        tower_organizations:
          - name: Default
            state: absent

        tower_teams:
          - name: test_team
            organization: test_organization
            state: absent

        tower_users:
          - username: test1
          - username: test2
        tower_users_defaults:
          state: absent

        tower_credentials:
          - name: test_credential
            description: Test credential
            kind: ssh
            username: test
            passwword: test
        tower_credentials_defaults:
          organization: test_organization
          user: admin
          state: absent

        tower_projects:
          - name: test_project
            state: absent

        tower_inventories:
          - name: "{{ tower_projects.0.name }}"
        tower_inventories_defaults:
          organization: test_organization
          state: absent

        tower_templates:
          - name: test_template
            project: test_project
            playbook: tomcat-standalone/site.yml
            state: absent

- name: Test tower role with rh
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.tower
      vars:
        tower_version: 3.5.3-1
        tower_type: rh
  tasks:
      - name: Verify awx console
        uri:
          url: http://localhost:80
          return_content: yes
          validate_certs: false

- name: Test tower role object removal with rh
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.tower
      vars:
        tower_version: 3.5.3-1
        tower_type: rh

        tower_organizations:
          - name: Default
            state: absent

        tower_teams:
          - name: test_team
            organization: test_organization
            state: absent

        tower_users:
          - username: test1
          - username: test2
        tower_users_defaults:
          state: absent

        tower_credentials:
          - name: test_credential
            description: Test credential
            kind: ssh
            username: test
            passwword: test
        tower_credentials_defaults:
          organization: test_organization
          user: admin
          state: absent

        tower_projects:
          - name: test_project
            state: absent

        tower_inventories:
          - name: "{{ tower_projects.0.name }}"
        tower_inventories_defaults:
          organization: test_organization
          state: absent

        tower_templates:
          - name: test_template
            project: test_project
            playbook: tomcat-standalone/site.yml
            state: absent

- name: Test tower role removal with rh
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.tower
      vars:
        tower_version: 3.5.3-1
        tower_state: absent
        tower_type: rh

- name: Cleanup vagrant sandbox
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vars:
        vagrant_sandbox_state: absent
  tags:
    - cleanup
    - sandbox
